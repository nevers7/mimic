---
title: "conrad_mimic"
author: "Bailey Conrad"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(coin)
library(rstatix)

```

```{r}
king <- read.csv("/Users/baileyconrad/Desktop/bewell/data/derived/RelAbun/RelAbun_king.csv", row.names = 1)
phyl <- read.csv("/Users/baileyconrad/Desktop/bewell/data/derived/RelAbun/RelAbun_phyl.csv",row.names = 1)
class <- read.csv("/Users/baileyconrad/Desktop/bewell/data/derived/RelAbun/RelAbun_class.csv",row.names = 1)
ord <- read.csv("/Users/baileyconrad/Desktop/bewell/data/derived/RelAbun/RelAbun_ord.csv", row.names = 1)
fam <- read.csv("/Users/baileyconrad/Desktop/bewell/data/derived/RelAbun/RelAbun_fam.csv", row.names = 1)
gen <- read.csv("/Users/baileyconrad/Desktop/bewell/data/derived/RelAbun/RelAbun_gen.csv", row.names = 1)
spec <- read.csv("/Users/baileyconrad/Desktop/bewell/data/derived/RelAbun/RelAbun_spec.csv", row.names = 1)
```

function to run wilcox test on pre/post BRB and return table of p-values
```{r}
run_wilcox <- function(level, str1, str2){
  microbes <- colnames(level)
  tableOfResults<-data.frame(var=microbes)
  tableOfResults$p_wilcox <- NA
  tableOfResults$effect_size <- NA
  rownames(tableOfResults) <- microbes

  tempR <- filter(level, grepl(str1, rownames(level)))
  tempT <- filter(level, grepl(str2, rownames(level)))

  for(mic in colnames(level)){
    x <- tempR[, mic]
    y <- tempT[, mic]
    x.df <- as.data.frame(x) %>%
    rename("rB" = x)
  y.df <- as.data.frame(y) %>%
    rename("tB" = y)
  temp <- cbind(x.df, y.df)
  temp$id <- rownames(temp)
  temp <- temp %>%
    gather(key = "group", value = "relAbun", rB, tB)
    thiscommand <- paste("thiswilcox <- wilcox.test(x, y, paired = TRUE)")
    eval(parse(text = thiscommand))
    tableOfResults[mic, "p_wilcox"] <- thiswilcox$p.value
    thiscommand <- paste("thiswilcox <- temp %>% wilcox_effsize(relAbun ~ group, paired = TRUE)")
    eval(parse(text = thiscommand))
    tableOfResults[mic, "effect_size"] <- thiswilcox$effsize
}
  tableOfResults <- tableOfResults %>% select(p_wilcox, effect_size)
  return(tableOfResults)
}
```

BRB all levels
```{r warning=FALSE}
spec_dif <- run_wilcox(spec, "rB", "tB")
gen_dif <- run_wilcox(gen, "rB", "tB")
fam_dif <- run_wilcox(fam, "rB", "tB")
ord_dif <- run_wilcox(ord, "rB", "tB")
class_dif <- run_wilcox(class, "rB", "tB")
phyl_dif <- run_wilcox(phyl, "rB", "tB")
king_dif <- run_wilcox(king, "rB", "tB")

#combine and filter to p-value < 0.05
BRBresults <- rbind(king_dif, phyl_dif, class_dif, ord_dif, fam_dif, gen_dif, spec_dif) %>% filter(p_wilcox < 0.05)
```

```{r}
BRBresults %>% ggplot(aes(x = rownames(BRBresults), y = p_wilcox)) +
  geom_bar(stat = "identity") +
  coord_flip()
```


```{r}
BRBresults %>% wilcox_effsize (relAbun ~ 1-rB)
```


```{r Effect Sizes Plot Creation}
# Filtering brb.total to only significant taxa
brb.sig <-
  brb.total %>%
  filter(padj < .05) 
  

brb.sig %>%
  ggplot(aes(x=log2FoldChange,
             y=reorder(Classification,log2FoldChange),
             fill=Tax)) + 
  geom_bar(stat = "identity") + 
  theme_bw() + 
  ggtitle("Effect Size BRB vs. NMBA - Significant Taxa") +
  ylab("Microbe Classification") +
  scale_fill_brewer(palette = "Set1") 
 

ggsave("../figures/effectsizebrb.png", width = 6, height = 4)
```


